@page "/overview"

@using FateExplorer.Components
@using FateExplorer.RollLogic
@using FateExplorer.ViewModel
@using System.IO
@using System

@inject IStringLocalizer<App> l10n
@inject ISnackbar Snackbar
@inject ITheHeroViMo Hero
@inject IRollHandlerViMo RollHandler

@if (Hero.HasBorn)
{
<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem xs=12 sm=6 md=5 lg=4>
            <MudPaper Elevation=0 Outlined=true Class="pa-4">
                <MudText Typo=Typo.body1 Class="mb-3">@Hero.Name</MudText>
                <div class="FieldParent">
                    <div class="mr-4 d-block Field" >
                        <MudText Typo=Typo.caption>@l10n["lblPlaceOfBirth"]</MudText>
                        <MudText Typo=Typo.body2 Class="mb-3">@Hero.PlaceOfBirth</MudText>
                    </div>
                    <div class="mr-4 d-block Field">
                        <MudText Typo=Typo.caption>@l10n["lblDateOfBirth"]</MudText>
                        <MudText Typo=Typo.body2>@Hero.DateOfBirth</MudText>
                    </div>
                </div>
            </MudPaper>


            <MudPaper Elevation=0 Outlined=true Class="pa-4">
                <div>
                @foreach (var ab in Hero.GetAbilites())
                {
                <AbilityChip Ability=@ab OnClick=@((MouseEventArgs e) => OnAbilityCheck(ab)) />
                }
                </div>
            </MudPaper>


            <MudPaper Elevation=0 Outlined=true Class="pa-4">
                @foreach (var r in Hero.GetResiliences())
                {
                <div class="d-inline">
                <MudTooltip Text=@r.Name>
                    <MudText Typo=Typo.caption>@r.ShortName @AddMaxResilience(r)</MudText>
                </MudTooltip>
                    <MudText Typo=Typo.body1 Class="mb-3">@r.EffectiveValue</MudText>
                </div>
                }
            </MudPaper>

            <MudPaper Elevation=0 Outlined=true Class="pa-4" Style="height: 200px;">
                <MudText Typo=Typo.body1>@l10n["MORE VALUES"]</MudText>
            </MudPaper>

            <MudPaper Elevation=0 Outlined=true Class="pa-4">
                <MudText Typo=Typo.caption>@l10n["lblBelongings"]</MudText>
                <MudText Typo=Typo.body1 Class="mb-3">n/a</MudText>

                <MudText Typo=Typo.caption>@l10n["lblWealth"]</MudText>
                <MudText Typo=Typo.body1 Class="mb-3">n/a</MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs=12 sm=6 md=7 lg=8>
            <MudPaper Square="true" Class="d-flex justify-space-around">
                <MudText Typo="Typo.h5" GutterBottom=true>@l10n["Roll Results"]</MudText>
                <MudSlider T=int Value=ModifyValue ValueChanged=@((int i) => OnModChanged(i)) 
                    Min=-10 Max=10 Step=1 Color=Color.Primary Class="mx-8">
                    @l10n["lblModifier"] @ModifyValue @(ModifyValue >= 0 ? "Bonus" : "Malus")
                </MudSlider>
            </MudPaper>
            <MudPaper Class="d-flex flex-column" Style="height:100%;" Outlined=true>
                @if (RollCheckResults is not null)
                {
                    @foreach(var r in RollCheckResults.Reverse())
                    {
                        <RollCheckCard Result=@r AvatarIcon=@CheckIcons ShowValueLabel=@l10n["lblAbility"]/>
                    }
                }
                else
                {
                    <span>Roll something</span>
                }
                </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>
}
else
{
<SkeletonNoCharacterData OnCharacterHasLoaded=@OnCharacterHasLoaded/>
}

@code {
    private readonly string[] CheckIcons = new string[4] { Icons.Filled.Accessible, Icons.Filled.Elderly, Icons.Filled.Accessibility, Icons.Filled.AccessibilityNew };

    private RollCheckResultViMo ActiveAbilityCheck;
    private EueuqMax<RollCheckResultViMo> RollCheckResults { get; set; }
    private int ModifyValue { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        if (RollCheckResults is null)
            RollCheckResults = new(4);
    }


    private void OnAbilityCheck(AbilityDTO ability)
    {
        ActiveAbilityCheck = RollHandler.OpenRollCheck(ability.Id, ability);
        ActiveAbilityCheck.CheckModifier.Set(ModifyValue);
        RollCheckResults.Enqueue(ActiveAbilityCheck);
    }


    private void OnModChanged(int NewValue)
    {
        ModifyValue = NewValue;
        ActiveAbilityCheck?.CheckModifier.Set(ModifyValue);
        StateHasChanged();
    }

    protected void OnCharacterHasLoaded() => StateHasChanged();


    RenderFragment AddMaxResilience(ResilienceDTO r)
    {
        if (r.Max != r.EffectiveValue)
            return 
                @<span>(Original @r.Max)</span>;
        else
            return @<span></span>;
    }
}
