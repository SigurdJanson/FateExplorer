@page "/shop"
@using FateExplorer.Shop

@inject IStringLocalizer<App> l10n
@inject ISnackbar Snackbar
@inject HttpClient httpClient

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudGrid>
        <MudItem xs=12>
            <MudText Typo=Typo.h3 Align=Align.Center GutterBottom=true>@l10n["naviShop"]</MudText>

            @if (Stock is not null)
            {
            <MudTable @ref="Table" ServerData="@(new Func<TableState, Task<TableData<ShopItemViMo>>>(ServerReload))"
                      FixedHeader=true Hover=true Striped=true Height="600px">
                <ToolBarContent>
                    <MudTextField T=string Clearable=true TextUpdateSuppression=false
                        DebounceInterval=250 OnDebounceIntervalElapsed=@(s=>OnSearch(s, selectedGroupId))
                        Placeholder=@l10n["lblSearch"] Adornment=Adornment.Start
                        AdornmentIcon=@Icons.Material.Filled.Search IconSize=Size.Medium Class="mt-0" />
                    <MudSelect T="int?" Class="mt-0" Clearable ValueChanged=@(g => OnSearch(searchString, g))
                         Label=@l10n["lblSelectStockCategory"]>
                        @foreach (var item in Stock.GetGroups())
                        {
                            <MudSelectItem Value=@((int?)item.id)>@item.name</MudSelectItem>
                        }
                    </MudSelect>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>@l10n["lblName"]</MudTh>
                    <MudTh>@l10n["lblPrice"] (S)</MudTh>
                    <MudTh>@l10n["lblWeight"] (@l10n["lblStone"])</MudTh>
                    <MudTh>@l10n["lblGroup"]</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudHighlighter Text=@context.Name HighlightedText=@searchString 
                            Style="background-color:transparent;font-weight:bold" />
                    </MudTd>
                    <MudTd DataLabel="Price">@context.Price</MudTd>
                    <MudTd DataLabel="Weight">@context.Weight</MudTd>
                    <MudTd DataLabel="Group">
                        <MudHighlighter Text=@l10n[context.Group.ToString()] HighlightedText=@searchString 
                            Style="background-color:transparent;font-weight:bold" />
                    </MudTd>
                </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudSkeleton SkeletonType=SkeletonType.Text Width="100%" />
                <MudText Typo=Typo.caption>Shop is about to be opened</MudText>
                <MudSkeleton SkeletonType=SkeletonType.Text Width="100%" />
            }
        </MudItem>
    </MudGrid>
</MudContainer>




@code {
    private MudTable<ShopItemViMo> Table;

    private ShopInventoryViMo Stock { get; set; }

    private string searchString = null;
    private int? selectedGroupId = null;

    private async Task<TableData<ShopItemViMo>> ServerReload(TableState state)
    {
        var data = await Task.Run(() => Stock.GetStock(searchString, selectedGroupId));
        return new TableData<ShopItemViMo>() { TotalItems = data.Count(), Items = data };
    }

    /// <summary>
    /// Reload table data on changed search parameters
    /// </summary>
    /// <param name="text">Text defining the free text search; 
    /// if <see cref="null"/> this value will not be updated</param>
    /// <param name="group">Number identifying the selected product group; 
    /// if <see cref="null"/> this value will not be updated</param>
    private void OnSearch(string text, int? group)
    {
        searchString = text;
        selectedGroupId = group;
        Table.ReloadServerData();
    }

    protected override async Task OnInitializedAsync()
    {
        base.OnInitialized();
        Stock = new ShopInventoryViMo(httpClient, l10n);
        await Stock.InitializeGameDataAsync();
    }
}
